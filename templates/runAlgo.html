<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Run Algorithm - StockAlgo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="navbar-nav mx-auto">
        <a class="nav-link" href="/">Home</a>
        <a class="nav-link" href="/stocks">Update Stocks</a>
        <a class="nav-link active" href="/run">Run Algo</a>
    </div>
</nav>

<div class="container-fluid px-lg-5 mt-5">
    <div class="row">
        <!-- Algorithm Form Section -->
        <div class="col-lg-4">
            <div class="card-custom">
                <h2>Run V20 Algorithm</h2>
                <form method="post" class="mt-4">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="history">History (in days)</label>
                            <input type="text" class="form-control" id="history" name="history" placeholder="e.g., 10" value="{{ history }}">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="margin">Margin (in percentage)</label>
                            <input type="text" class="form-control" id="margin" name="margin" placeholder="e.g., 20" value="{{ margin }}">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="filter-by-last-close" value="1" id="filter-by-last-close" checked>
                            <label class="form-check-label" for="filter-by-last-close">
                                Compare with latest price?
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="last-close-margin">Margin for latest price comparison (in percentage)</label>
                        <input type="text" class="form-control" id="last-close-margin" name="last-close-margin" placeholder="e.g., 5" value="{{ last_close_margin }}">
                    </div>
                    <div class="form-group">
                        <label for="stocksTextArea">Stock Symbols</label>
                        <textarea class="form-control" id="stocksTextArea" name="stocks" rows="10">{{ stocks }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Run Algorithm</button>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div class="col-lg-8">
            {% if result %}
                <div class="card-custom">
                    <h3>Algorithm Results</h3>
                    {% if result[0] == "No results!" %}
                        <div class="text-center">
                            <p class="lead mb-0">No matching results found with the current parameters.</p>
                        </div>
                    {% else %}
                        <div class="row align-items-center mb-4">
                            <div class="col-md-8">
                                <input type="text" class="search-box" id="tableSearch" placeholder="Search stock names...">
                                <div id="autocomplete-list" class="autocomplete-items empty"></div>
                            </div>
                            <div class="col-md-4 d-none d-md-block">
                                <div class="stats-dashboard justify-content-end">
                                    <div class="stat-item">
                                        <span class="stat-number" id="uniqueStocks">0</span>
                                        <span class="stat-label">Unique Stocks</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="results-table">
                            <table id="resultsTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="stock">Stock</th>
                                        <th class="sortable" data-sort="profit_margin">Profit Margin %</th>
                                        <th class="sortable" data-sort="v20margin">V20 Margin %</th>
                                        <th class="sortable" data-sort="ma">200MA(₹)</th>
                                        <th class="sortable" data-sort="low_date">Start Date</th>
                                        <th class="sortable" data-sort="low_price">Low Price(₹)</th>
                                        <th class="sortable" data-sort="high_date">High Date</th>
                                        <th class="sortable" data-sort="high_price">High Price(₹)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in result %}
                                    <tr>
                                        <td data-label="Stock" class="stock-cell">
                                            <a href="https://www.tradingview.com/symbols/NSE-{{ r.stock }}/" target="_blank" class="stock-link">
                                                {{ r.stock }}
                                            </a>
                                        </td>
                                        <td data-label="Profit Margin %" class="profit-margin-cell">{{ r.profit_margin }}%</td>
                                        <td data-label="V20 Margin %" class="v20margin-cell">{{ r.v20margin }}%</td>
                                        <td data-label="200MA" class="ma-cell">{{ r.ma }}</td>
                                        <td data-label="Start Date" class="date-cell">{{ r.low_date }}</td>
                                        <td data-label="Low Price" class="price-cell">{{ r.low_price }}</td>
                                        <td data-label="High Date" class="date-cell">{{ r.high_date }}</td>
                                        <td data-label="High Price" class="price-cell">{{ r.high_price }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div class="no-results-message" id="noResultsMessage">
                                <p>No results match your search criteria</p>
                                <small>Try adjusting your search terms</small>
                            </div>
                        </div>
                        <!-- Mobile cards layout -->
                        <div class="mobile-results-cards d-block d-md-none mt-3">
                            {% for r in result %}
                            <div class="result-card mb-4 p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="font-weight-bold text-uppercase">Stock</span>
                                    <a href="https://www.tradingview.com/symbols/NSE-{{ r.stock }}/" target="_blank" class="font-weight-bold text-uppercase stock-link">{{ r.stock }}</a>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="font-weight-bold text-success">Profit Margin %</span>
                                    <span class="font-weight-bold text-success">{{ r.profit_margin }}%</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="font-weight-bold text-success">V20 Margin %</span>
                                    <span class="font-weight-bold text-success">{{ r.v20margin }}%</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="font-weight-bold text-primary">200MA</span>
                                    <span class="font-weight-bold text-primary">₹{{ r.ma }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="font-weight-bold text-secondary">Start Date</span>
                                    <span class="font-weight-bold text-secondary">{{ r.low_date }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="font-weight-bold text-secondary">Low Price</span>
                                    <span class="font-weight-bold text-secondary">₹{{ r.low_price }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="font-weight-bold text-secondary">High Date</span>
                                    <span class="font-weight-bold text-secondary">{{ r.high_date }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="font-weight-bold text-secondary">High Price</span>
                                    <span class="font-weight-bold text-secondary">₹{{ r.high_price }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="card-custom text-center">
                    <h3>Ready to Run Algorithm</h3>
                    <p class="lead">Fill out the form on the left and click "Run Algorithm" to see results here.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
// Table sorting and searching functionality
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('resultsTable');
    const searchBox = document.getElementById('tableSearch');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const uniqueStocks = document.getElementById('uniqueStocks');
    let currentSort = { column: null, direction: 'asc' };

    // Calculate unique stocks
    function calculateUniqueStocks() {
        const rows = table.querySelectorAll('tbody tr');
        const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');

        if (visibleRows.length === 0) {
            uniqueStocks.textContent = '0';
            return;
        }

        // Calculate unique stocks
        const stocks = visibleRows.map(row => row.querySelector('.stock-cell').textContent);
        const uniqueStocksSet = new Set(stocks);
        uniqueStocks.textContent = uniqueStocksSet.size;
    }

    // Search functionality
    searchBox.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = table.querySelectorAll('tbody tr');
        let visibleRows = 0;

        rows.forEach(row => {
            // Only match the stock name cell
            const stockCell = row.querySelector('.stock-cell');
            let stockName = stockCell ? stockCell.textContent.toLowerCase() : '';
            if (stockName.includes(searchTerm)) {
                row.style.display = '';
                visibleRows++;
            } else {
                row.style.display = 'none';
            }
        });

        // Show/hide no results message
        if (visibleRows === 0) {
            noResultsMessage.classList.add('show');
        } else {
            noResultsMessage.classList.remove('show');
        }

        // Update stats
        calculateUniqueStocks();

        // Also filter mobile cards by stock name only
        if (window.innerWidth <= 768) {
            filterMobileCards(searchTerm);
        }
    });

    // Calculate initial stats
    calculateUniqueStocks();

    // Sorting functionality
    table.querySelectorAll('th.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.sort;
            const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';

            // Update sort indicators
            table.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            this.classList.add(direction);

            currentSort = { column, direction };
            sortTable(column, direction);
        });
    });

    function sortTable(column, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal = a.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent;
            let bVal = b.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent;

            // Handle different data types
            if (column === 'margin' || column === 'ma' || column === 'low_price' || column === 'high_price') {
                aVal = parseFloat(aVal.replace(/[^\d.-]/g, ''));
                bVal = parseFloat(bVal.replace(/[^\d.-]/g, ''));
            } else if (column === 'low_date' || column === 'high_date') {
                aVal = new Date(aVal.split('-').reverse().join('-'));
                bVal = new Date(bVal.split('-').reverse().join('-'));
            }

            if (direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        // Reorder rows
        rows.forEach(row => tbody.appendChild(row));
    }

    function getColumnIndex(column) {
        const columnMap = {
            'stock': 1,
            'margin': 2,
            'ma': 3,
            'low_date': 4,
            'low_price': 5,
            'high_date': 6,
            'high_price': 7
        };
        return columnMap[column];
    }
});

// Mobile card search functionality
function filterMobileCards(searchTerm) {
    const cards = document.querySelectorAll('.mobile-results-cards .result-card');
    let visibleCount = 0;
    cards.forEach(card => {
        // Find the stock name span (second .font-weight-bold.text-uppercase)
        const stockSpans = card.querySelectorAll('.font-weight-bold.text-uppercase');
        let stockName = '';
        if (stockSpans.length > 1) {
            stockName = stockSpans[1].textContent.toLowerCase();
        }
        if (stockName.includes(searchTerm)) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    // Optionally, show/hide a 'no results' message for cards
}

// Attach search event for mobile cards
const searchBox = document.getElementById('tableSearch');
if (searchBox) {
    searchBox.addEventListener('input', function() {
        if (window.innerWidth <= 768) {
            filterMobileCards(this.value.toLowerCase());
        }
    });
}

// Autocomplete for stock names
function getAllStockNames() {
    // For table: get all visible stock names
    const tableStocks = Array.from(document.querySelectorAll('#resultsTable .stock-cell'));
    const names = tableStocks.map(cell => cell.textContent.trim());
    // For cards: get all visible card stock names
    const cardStocks = Array.from(document.querySelectorAll('.mobile-results-cards .result-card'));
    cardStocks.forEach(card => {
        const stockSpans = card.querySelectorAll('.font-weight-bold.text-uppercase');
        if (stockSpans.length > 1) {
            names.push(stockSpans[1].textContent.trim());
        }
    });
    // Remove duplicates
    return Array.from(new Set(names));
}

const autocompleteList = document.getElementById('autocomplete-list');
searchBox.addEventListener('input', function() {
    // ... existing search code ...
    // Autocomplete logic
    const val = this.value.toLowerCase();
    autocompleteList.innerHTML = '';
    autocompleteList.classList.add('empty');
    if (!val) return;
    const stockNames = getAllStockNames();
    const matches = stockNames.filter(name => name.toLowerCase().includes(val));
    if (matches.length > 0) autocompleteList.classList.remove('empty');
    matches.slice(0, 8).forEach(name => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = name.replace(new RegExp(val, 'gi'), match => `<strong>${match}</strong>`);
        item.addEventListener('mousedown', function(e) {
            searchBox.value = name;
            searchBox.dispatchEvent(new Event('input'));
            autocompleteList.innerHTML = '';
            autocompleteList.classList.add('empty');
        });
        autocompleteList.appendChild(item);
    });
});
document.addEventListener('click', function(e) {
    if (e.target !== searchBox) {
        autocompleteList.innerHTML = '';
        autocompleteList.classList.add('empty');
    }
});
</script>

<footer class="footer">
    <div class="container-fluid px-lg-5">
        <div class="footer-content">
        </div>
    </div>
</footer>

</body>
</html>
